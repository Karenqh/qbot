<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html">
<head>
    <title>QBot Web View</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="css/style.css">
    <link href="css/bootstrap.min.css" type="text/css" rel="stylesheet">
    <style>
	    #vid-box video{
		    width: 400px;
	    }
    </style>
    
</head>
<body>
  <div class="header alert alert-info">
    <h4>QBot Web View</h4>
    <p>This web interface can receive and send calls to the <a href="https://github.com/Karenqh/qbot" target="_blank">QBot Android app</a>.<p>
  </div>
  <div id="core" class="flexbox">
    <div id="login" class="block">
      <label class="control-label">Username</label>
          <form class="input-group" name="loginForm" id="login" action="#" onsubmit="return login(this);">
             <span class="input-group-addon">@</span>
             <input type="text" class="form-control" name="username" id="username" placeholder="Skywalker..." >
             <span class="input-group-btn">
                 <button type="submit" name="login_submit" class="btn btn-default">Log In</button>
             </span>
          </form>
       <label class="control-label">Robot Name</label>
          <form class="input-group" name="callForm" id="call" action="#" onsubmit="return connectReceiver(this);">
             <input type="text" class="form-control" name="number" id="number" placeholder="R2D2..." >
             <span class="input-group-btn">
                 <button type="submit" name="robotname_submit" class="btn btn-default">Connect</button>
             </span>
          </form>
      <div class="div-table-row">
        <button onclick="makeCall()" class="btn btn-primary btn-lg">Call</button>
        <button onclick="endCall()" class="btn btn-primary btn-lg">End Call</button>
      </div>
    </div>
    <div id="vid-box" class="block">[<i>Video will appear here</i>]</div>
    <div class="block" id="controlButton">
      <div class="div-table-row">
        <div class="div-table-cell">
          <button onclick="fowardButton()" class="btn btn-info btn-lg">Foward</button>
        </div>
      </div>
      <div class="div-table-row">
        <div class="div-table-cell">
          <button onclick="LeftButton()" class="btn btn-info btn-lg">Left</button>
        </div>
        <div class="div-table-cell">
          <button onclick="RightButton()" class="btn btn-info btn-lg">Right</button>
        </div>
      </div>
      <div class="div-table-row">
        <div class="div-table-cell">
          <button onclick="backButton()" class="btn btn-info btn-lg">Back</button>
        </div>
      </div>
    </div>
  </div>
  <div class="flexbox">
    <div class="block" id="chatblock">
       <label class="control-label">Chat</label>
          <div class="input-group" >
             <input type="text" class="form-control" id="chat-msg" placeholder="Enter a message..." >
             <span class="input-group-btn">
                 <button onclick="sendMessage()" class="btn btn-default">Send</button>
             </span>
         </div> <br>
      <div class="panel panel-info">
  <div class="panel-heading">
    
    <h3 class="panel-title">Chat History</h3>
  </div>
  <div class="panel-body" id="chat-box">
    [<i>Chat will appear here</i>]
  </div>
</div>
  </div>
</body>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="https://cdn.pubnub.com/pubnub.min.js"></script>
<script src="js/webrtc.js"></script>
<script type="text/javascript">

var video_out = document.getElementById("vid-box");
var chat_box  = document.getElementById("chat-box");
var chat_msg  = document.getElementById("chat-msg");
var pub_key = "pub-c-d77705ee-8dc9-417b-9c49-c726f65d4eeb";
var sub_key = "sub-c-db247f12-d42b-11e5-8a35-0619f8945a4f";
var standby_suffix = "-stdby";
var userId = "";
var callReceiver = "";

function login(form){
	userId = form.username.value || "Anonymous";
	var userIdStdBy = userId + standby_suffix;
	var pubnub = window.pubnub = PUBNUB({                          
        publish_key   : pub_key,
        subscribe_key : sub_key,
        uuid: userId
	});
	
	pubnub.subscribe({                                     
        channel : userIdStdBy,
        state : {"status" : "Available"},
        message: function(m){console.log()},
        connect: function(e){ 
        	form.login_submit.disabled = true;
        	form.login_submit.className = "btn btn-success disabled";
			form.username.style.background="#55ff5b";
			console.log(JSON.stringify(e));
	        console.log("Subscribed and ready!");  
	    }
    });
    return false;
}

function phoneStart() {
	var phone = window.phone = PHONE({
	    number        : userId || "Anonymous", // listen on username line else Anonymous
	    publish_key   : pub_key, // Your Pub Key
	    subscribe_key : sub_key, // Your Sub Key
	    oneway        : true, // one way stream
	});	
	phone.ready(function(){
		console.log("Phone ON!");
	});
	phone.receive(function(session){
		session.message(message);
	    session.connected(function(session) {
	    	video_out.style.display = 'block';
	    	video_out.innerHTML="";
	    	video_out.appendChild(session.video);  
	    });
	    session.ended(function(session) { video_out.innerHTML=''; video_out.style.display = 'none';});
	});
}

//jsonCall.put(Constants.JSON_CALL_USER, username);
//jsonCall.put(Constants.JSON_CALL_TIME, System.currentTimeMillis());

function makeCall(){
	var stdByCh  = callReceiver + standby_suffix;
	var msg = {"call_user":userId,"call_time":new Date().getMilliseconds()};
	console.log("HERE" + callReceiver + stdByCh);
	window.pubnub.publish({
		channel:stdByCh,
		message:msg,
		callback:function(m){ console.log(m); }
	});
	if (!window.phone) phoneStart();
// 	window.phone.dial(callUser); 
}

function connectReceiver(form){
	if (!window.pubnub) alert("Login First!");
	callReceiver = form.number.value;
	//Check whether receiver is online
	window.pubnub.state({
		channel:callReceiver+"-stdby",
	    uuid : callReceiver,
	    callback: function(m){
	    	if (m.status=="Available"){
		                      form.number.style.background="#55ff5b";
		                      form.robotname_submit.disabled = true;
		                  	  form.robotname_submit.className = "btn btn-success disabled";
		                      console.log(JSON.stringify(m));	
	    	}
	    	else {
	    		var msg = {"pn_gcm":{"data":{message:"wake up call from qbotweb"}}};
		    	console.log("HERE publish to gcm channel");
		    	window.pubnub.publish({
		    		channel:"GCMPush",
		    		message:msg,
		    		callback:function(m){ console.log(m); }
		    	})
	    	}
	    }
	});	
	return false;
}

function endCall(){
	if(window.phone) window.phone.hangup();
}

function message( session, message ) {
    add_chat( session.number, message );
}

function add_chat(number, message){
	console.log(number + ": " + message);
	chat_box.innerHTML = "<p>" + number+" ("+ formatTime(message["msg_timestamp"]) +"): " + message["msg_message"] + "</p>" + chat_box.innerHTML;
}

function sendMessage(){
	var msg = chat_msg.value;
	if (msg==='' || !window.phone) return alert("Not in a call.");
	var chatMsg = {'msg_uuid': safetxt(userId), 'msg_message': safetxt(msg), 'msg_timestamp':new Date().getTime()};
	phone.send(chatMsg);
	console.log(msg);
	add_chat("Me: ", chatMsg);
}

// Will format in 12-hour h:mm.s a time format
function formatTime(millis){
	var d = new Date(millis);
	var h = d.getHours();
	var m = d.getMinutes();
	var s = d.getSeconds();
	var a = (Math.floor(h/12)===0) ? "am" : "pm";
	return (h%12)+":"+m+"."+s + " " + a;
}

// -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=->
// XSS Prevent
// -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=->
function safetxt(text) {
    return (''+text).replace( /[<>]/g, '' );
}

</script>

</html>
